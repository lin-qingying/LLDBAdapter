syntax = "proto3";

package lldbprotobuf;
import "model.proto";

/*
 * ========================================================================
 * LLDB 定制调试协议 - 事件消息定义（Proto3）
 *
 * 文件说明：
 *   本文件定义了调试后端异步推送给客户端（IDE/前端）的事件消息。
 *   事件消息用于通知客户端调试状态的变化，如：
 *   - 进程生命周期事件（启动、停止、退出）
 *   - 断点事件（命中、状态变更）
 *   - 模块事件（加载、卸载）
 *   - 输出事件（标准输出、标准错误）
 *
 * 设计说明：
 *   - 事件是异步推送的，不需要请求
 *   - 事件通过 Response 消息封装发送（hash 字段可为空）
 *   - 客户端应准备随时接收事件
 *
 * 事件触发时机：
 *   - ProcessStopped: 进程暂停时（断点、单步、信号等）
 *   - ProcessRunning: 进程恢复执行时
 *   - ProcessExited: 进程退出时
 *   - ProcessOutput: 进程输出时（stdout/stderr）
 *   - ModuleEvent: 模块加载/卸载时
 *   - BreakpointChangedEvent: 断点状态变化时
 * ========================================================================
 */


/* =========================================================================
 * 初始化事件
 * ========================================================================= */

/**
 * 调试器初始化完成事件
 *
 * 当调试器完成初始化并准备好接受请求时发送。
 * 客户端收到此事件后可以开始发送调试请求。
 */
message Initialized {
  // 调试器能力标志位
  // 使用位掩码表示支持的功能
  // 具体位定义由实现决定
  uint64 capabilities = 3;
}


/* =========================================================================
 * 进程生命周期事件
 * ========================================================================= */

/**
 * 进程停止事件
 *
 * 当被调试进程因任何原因暂停执行时发送。
 * 这是最重要的事件之一，前端需要据此更新所有调试视图。
 *
 * 触发条件：
 *   - 命中断点
 *   - 单步执行完成
 *   - 收到信号（如 SIGINT）
 *   - 发生异常
 *   - 用户请求暂停
 *
 * 前端处理：
 *   - 更新线程列表和状态
 *   - 更新当前栈帧
 *   - 刷新变量视图
 *   - 定位到停止位置的源代码
 */
message ProcessStopped {
  // 触发暂停的线程信息
  // 包含线程 ID、停止原因等详细信息
  Thread stopped_thread = 1;

  // 当前栈帧
  // 被中断线程的顶层栈帧，包含函数名、源码位置等
  Frame current_frame = 2;
}

/**
 * 进程恢复执行事件
 *
 * 当进程从暂停状态恢复执行时发送。
 * 通常在执行 continue、step 命令后触发。
 *
 * 前端处理：
 *   - 禁用变量查看（运行中无法查看）
 *   - 更新 UI 状态为"运行中"
 *   - 可能需要禁用某些调试操作
 */
message ProcessRunning {
  // 恢复执行的线程（可选）
  // 如果是特定线程恢复，此字段包含线程 ID
  // 如果是所有线程恢复，此字段可能为空
  Id thread = 2;
}

/**
 * 进程退出事件
 *
 * 当被调试进程退出时发送。
 * 无论是正常退出还是异常终止都会触发此事件。
 *
 * 前端处理：
 *   - 显示退出信息
 *   - 清理调试状态
 *   - 可能提示用户是否重新启动
 */
message ProcessExited {
  // 进程退出码
  // 0 通常表示正常退出
  // 非 0 表示异常退出或返回错误
  int32 exit_code = 2;

  // 退出描述（可选）
  // 提供额外的退出信息
  // 示例: "被信号 SIGSEGV 终止", "正常退出"
  optional string exit_description = 3;
}


/* =========================================================================
 * 输出事件
 * ========================================================================= */

/**
 * 进程输出事件
 *
 * 当被调试进程产生输出时发送。
 * 包括标准输出（stdout）和标准错误（stderr）。
 *
 * 前端处理：
 *   - 将输出显示在控制台视图中
 *   - 可以根据 output_type 使用不同颜色区分
 */
message ProcessOutput {
  // 输出文本内容
  // 可能包含多行
  string text = 1;

  // 输出类型
  // stdout: 标准输出
  // stderr: 标准错误
  OutputType output_type = 2;
}


/* =========================================================================
 * 模块事件
 * ========================================================================= */

/**
 * 模块事件
 *
 * 当模块（可执行文件、共享库）被加载或卸载时发送。
 *
 * 触发条件：
 *   - 进程启动时加载主程序和依赖库
 *   - 动态加载共享库（如 dlopen）
 *   - 卸载共享库（如 dlclose）
 *
 * 前端处理：
 *   - 更新模块列表视图
 *   - 可能需要更新断点状态（新模块可能解析待定断点）
 */
message ModuleEvent {
  // 事件类型
  // MODULE_LOADED: 模块已加载
  // MODULE_UNLOADED: 模块已卸载
  EventType event_type = 1;

  // 相关模块列表
  // 可能一次加载/卸载多个模块
  repeated Module modules = 2;
}


/* =========================================================================
 * 断点事件
 * ========================================================================= */

/**
 * 断点变更事件
 *
 * 当断点状态发生变化时发送。
 *
 * 触发条件：
 *   - 断点被添加
 *   - 断点被删除
 *   - 断点被启用/禁用
 *   - 断点位置被解析（如模块加载后）
 *   - 断点条件被修改
 *
 * 前端处理：
 *   - 更新断点列表视图
 *   - 更新源代码编辑器中的断点标记
 */
message BreakpointChangedEvent {
  // 断点信息
  // 包含断点 ID、位置等
  Breakpoint breakpoint = 1;

  // 变更类型
  // 描述断点发生了什么变化
  BreakpointEventType change_type = 2;

  // 变更描述（可选）
  // 提供额外的变更信息
  optional string description = 3;
}


/* =========================================================================
 * 线程状态事件
 * ========================================================================= */

/**
 * 线程状态变更事件
 *
 * 当线程状态发生变化时发送。
 *
 * 触发条件：
 *   - 线程被创建
 *   - 线程被销毁
 *   - 线程被挂起/恢复
 *   - 用户切换查看的线程
 *   - 线程的调用栈发生变化
 *
 * 前端处理：
 *   - 更新线程列表视图
 *   - 如果是当前线程，可能需要刷新栈帧视图
 */
message ThreadStateChangedEvent {
  // 线程信息
  // 包含线程 ID、名称、状态等
  Thread thread = 1;

  // 状态变更类型
  // 描述线程状态发生了什么变化
  ThreadStateChangeType change_type = 2;

  // 变更描述（可选）
  // 提供额外的变更信息
  optional string description = 3;
}


/* =========================================================================
 * 符号加载事件
 * ========================================================================= */

/**
 * 符号加载事件
 *
 * 当调试符号被加载时发送。
 *
 * 触发条件：
 *   - 模块加载时自动加载符号
 *   - 用户手动加载符号文件
 *   - 从符号服务器下载符号完成
 *
 * 前端处理：
 *   - 更新模块视图（显示符号状态）
 *   - 可能需要刷新栈帧（现在有符号信息了）
 *   - 可能需要重新解析断点
 */
message SymbolsLoadedEvent {
  // 加载符号的模块信息
  Module module = 1;

  // 加载的符号数量
  uint32 symbol_count = 2;

  // 符号文件路径（可选）
  // 如果是从外部文件加载的符号
  optional string symbol_file_path = 3;
}


/* =========================================================================
 * 顶层事件消息
 *
 * 所有事件都通过此消息封装，然后通过 Response 消息发送。
 * ========================================================================= */

/**
 * 顶层事件消息
 *
 * 调试后端异步发送给客户端的所有事件都封装在此消息中。
 *
 * 使用说明：
 *   - 事件通过 Response 消息的 event 字段发送
 *   - Response 的 hash 字段在事件消息中可以为空或任意值
 *   - 客户端应随时准备接收事件
 *
 * 事件处理建议：
 *   - 使用独立的事件处理线程/协程
 *   - 事件可能在任何时候到达
 *   - 某些事件需要刷新 UI（如 ProcessStopped）
 */
message Event {
  // 具体事件类型（互斥选择）
  oneof body {
    // ===== 初始化事件 =====
    // 调试器初始化完成
    Initialized initialized = 1;

    // ===== 进程生命周期事件 =====
    // 进程暂停（断点、单步、信号等）
    ProcessStopped process_stopped = 2;

    // 进程恢复执行
    ProcessRunning process_running = 3;

    // 进程退出
    ProcessExited process_exited = 4;

    // ===== 输出事件 =====
    // 进程输出（stdout/stderr）
    ProcessOutput process_output = 7;

    // ===== 模块事件 =====
    // 模块加载/卸载
    ModuleEvent module_event = 8;

    // ===== 断点事件 =====
    // 断点状态变更
    BreakpointChangedEvent breakpoint_changed_event = 9;

    // ===== 线程事件 =====
    // 线程状态变更
    ThreadStateChangedEvent thread_state_changed_event = 10;

    // ===== 符号事件 =====
    // 符号加载
    SymbolsLoadedEvent symbols_loaded_event = 11;
  }
}