
name: Multi-Platform Build

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PROJECT_NAME: CangJieLLDBAdapter
  CMAKE_VERSION: 3.27.0
  BUILD_TYPE: Release

jobs:
  # ============== Linux AMD64 ==============
  build-linux-amd64:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc \
            g++ \
            ninja-build \
            ccache \
            protobuf-compiler \
            libprotobuf-dev

      - name: Cache protobuf build
        uses: actions/cache@v4
        with:
          path: |
            build/third_party/protobuf-build
            build/third_party/protobuf-install
          key: ${{ runner.os }}-protobuf-${{ hashFiles('third_party/protobuf/**') }}
          restore-keys: |
            ${{ runner.os }}-protobuf-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Configure CMake
        run: |
          export PATH="/usr/lib/ccache:$PATH"
          cmake -B build \
            -GNinja \
            -DCMAKE_TOOLCHAIN_FILE=cmake/toolchains/linux-amd64.cmake \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build
        run: |
          export PATH="/usr/lib/ccache:$PATH"
          ninja -C build

      - name: Strip binary
        run: |
          if [ -f "build/output/${{ env.PROJECT_NAME }}_linux_amd64" ]; then
            strip build/output/${{ env.PROJECT_NAME }}_linux_amd64
          elif [ -f "output/${{ env.PROJECT_NAME }}_linux_amd64" ]; then
            strip output/${{ env.PROJECT_NAME }}_linux_amd64
          fi

      - name: Rename binary
        run: |
          if [ -f "build/output/${{ env.PROJECT_NAME }}_linux_amd64" ]; then
            cp build/output/${{ env.PROJECT_NAME }}_linux_amd64 ${{ env.PROJECT_NAME }}_linux_amd64
          elif [ -f "output/${{ env.PROJECT_NAME }}_linux_amd64" ]; then
            cp output/${{ env.PROJECT_NAME }}_linux_amd64 ${{ env.PROJECT_NAME }}_linux_amd64
          else
            echo "Error: Binary not found"
            ls -la build/output/ || ls -la output/ || true
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-amd64
          path: ${{ env.PROJECT_NAME }}_linux_amd64
          retention-days: 7

  # ============== Linux ARM64 (交叉编译) ==============
  build-linux-arm64:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Install ARM64 cross-compile tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc \
            g++ \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu \
            ninja-build

      - name: Cache host protobuf build
        uses: actions/cache@v4
        with:
          path: |
            cmake-build-linux-amd64/third_party
          key: ${{ runner.os }}-host-protobuf-${{ hashFiles('third_party/protobuf/**') }}
          restore-keys: |
            ${{ runner.os }}-host-protobuf-

      - name: Cache target protobuf build
        uses: actions/cache@v4
        with:
          path: |
            cmake-build-linux-arm64/third_party
          key: ${{ runner.os }}-arm64-protobuf-${{ hashFiles('third_party/protobuf/**') }}
          restore-keys: |
            ${{ runner.os }}-arm64-protobuf-

      - name: Make script executable
        run: chmod +x scripts/linux-amd64-to-arm64.sh

      - name: Cross-compile using automated script
        run: ./scripts/linux-amd64-to-arm64.sh
        env:
          BUILD_TYPE: ${{ env.BUILD_TYPE }}

      - name: Strip binary
        run: |
          if [ -f "output/${{ env.PROJECT_NAME }}_linux_arm64" ]; then
            aarch64-linux-gnu-strip output/${{ env.PROJECT_NAME }}_linux_arm64
          else
            echo "Error: Binary not found"
            ls -la output/ || true
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64
          path: output/${{ env.PROJECT_NAME }}_linux_arm64
          retention-days: 7

  # ============== Windows AMD64 ==============
  build-windows-amd64:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Setup MinGW
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-ccache
            make

      - name: Cache protobuf build
        uses: actions/cache@v4
        with:
          path: |
            build/third_party/protobuf-build
            build/third_party/protobuf-install
          key: ${{ runner.os }}-protobuf-${{ hashFiles('third_party/protobuf/**') }}
          restore-keys: |
            ${{ runner.os }}-protobuf-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Configure CMake
        shell: msys2 {0}
        run: |
          export CC=/mingw64/bin/gcc
          export CXX=/mingw64/bin/g++
          cmake -B build \
            -DCMAKE_TOOLCHAIN_FILE=cmake/toolchains/windows-amd64.cmake \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_C_COMPILER=/mingw64/bin/gcc.exe \
            -DCMAKE_CXX_COMPILER=/mingw64/bin/g++.exe \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -G "Ninja"

      - name: Build
        shell: msys2 {0}
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      - name: Rename binary
        shell: pwsh
        run: |
          $sourcePaths = @(
            "build/output/${{ env.PROJECT_NAME }}_windows_amd64.exe",
            "output/${{ env.PROJECT_NAME }}_windows_amd64.exe",
            "build/output/${{ env.PROJECT_NAME }}.exe",
            "output/${{ env.PROJECT_NAME }}.exe",
            "build/${{ env.BUILD_TYPE }}/${{ env.PROJECT_NAME }}.exe"
          )
          foreach ($path in $sourcePaths) {
            if (Test-Path $path) {
              Write-Host "Found binary at: $path"
              Copy-Item $path "${{ env.PROJECT_NAME }}_windows_amd64.exe"
              break
            }
          }
          if (-not (Test-Path "${{ env.PROJECT_NAME }}_windows_amd64.exe")) {
            Write-Host "Error: Binary not found in any of the expected locations"
            Write-Host "Listing build directory contents:"
            Get-ChildItem -Recurse build | Where-Object { $_.Extension -eq ".exe" }
            exit 1
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-amd64
          path: ${{ env.PROJECT_NAME }}_windows_amd64.exe
          retention-days: 7

  # ============== macOS AMD64 ==============
  build-macos-amd64:
    runs-on: macos-13  # Intel Mac

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Install dependencies
        run: |
          brew install llvm ccache || true

      - name: Cache protobuf build
        uses: actions/cache@v4
        with:
          path: |
            build/third_party/protobuf-build
            build/third_party/protobuf-install
          key: ${{ runner.os }}-amd64-protobuf-${{ hashFiles('third_party/protobuf/**') }}
          restore-keys: |
            ${{ runner.os }}-amd64-protobuf-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/ccache
          key: ${{ runner.os }}-amd64-ccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-amd64-ccache-

      - name: Configure CMake
        run: |
          export PATH="$(brew --prefix)/opt/ccache/libexec:$PATH"
          cmake -B build \
            -DCMAKE_TOOLCHAIN_FILE=cmake/toolchains/macos-amd64.cmake \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build
        run: |
          export PATH="$(brew --prefix)/opt/ccache/libexec:$PATH"
          cmake --build build --config ${{ env.BUILD_TYPE }} -j$(sysctl -n hw.ncpu)

      - name: Strip binary
        run: |
          if [ -f "build/output/${{ env.PROJECT_NAME }}_macos_amd64" ]; then
            strip build/output/${{ env.PROJECT_NAME }}_macos_amd64
          elif [ -f "output/${{ env.PROJECT_NAME }}_macos_amd64" ]; then
            strip output/${{ env.PROJECT_NAME }}_macos_amd64
          fi

      - name: Rename binary
        run: |
          if [ -f "build/output/${{ env.PROJECT_NAME }}_macos_amd64" ]; then
            cp build/output/${{ env.PROJECT_NAME }}_macos_amd64 ${{ env.PROJECT_NAME }}_macos_amd64
          elif [ -f "output/${{ env.PROJECT_NAME }}_macos_amd64" ]; then
            cp output/${{ env.PROJECT_NAME }}_macos_amd64 ${{ env.PROJECT_NAME }}_macos_amd64
          else
            echo "Error: Binary not found"
            ls -la build/output/ || ls -la output/ || true
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-amd64
          path: ${{ env.PROJECT_NAME }}_macos_amd64
          retention-days: 7

  # ============== macOS ARM64 ==============
  build-macos-arm64:
    runs-on: macos-14  # Apple Silicon Mac

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Install dependencies
        run: |
          brew install llvm ccache || true

      - name: Cache protobuf build
        uses: actions/cache@v4
        with:
          path: |
            build/third_party/protobuf-build
            build/third_party/protobuf-install
          key: ${{ runner.os }}-arm64-protobuf-${{ hashFiles('third_party/protobuf/**') }}
          restore-keys: |
            ${{ runner.os }}-arm64-protobuf-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/ccache
          key: ${{ runner.os }}-arm64-ccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-arm64-ccache-

      - name: Configure CMake
        run: |
          export PATH="$(brew --prefix)/opt/ccache/libexec:$PATH"
          cmake -B build \
            -DCMAKE_TOOLCHAIN_FILE=cmake/toolchains/macos-arm64.cmake \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build
        run: |
          export PATH="$(brew --prefix)/opt/ccache/libexec:$PATH"
          cmake --build build --config ${{ env.BUILD_TYPE }} -j$(sysctl -n hw.ncpu)

      - name: Strip binary
        run: |
          if [ -f "build/output/${{ env.PROJECT_NAME }}_macos_arm64" ]; then
            strip build/output/${{ env.PROJECT_NAME }}_macos_arm64
          elif [ -f "output/${{ env.PROJECT_NAME }}_macos_arm64" ]; then
            strip output/${{ env.PROJECT_NAME }}_macos_arm64
          fi

      - name: Rename binary
        run: |
          if [ -f "build/output/${{ env.PROJECT_NAME }}_macos_arm64" ]; then
            cp build/output/${{ env.PROJECT_NAME }}_macos_arm64 ${{ env.PROJECT_NAME }}_macos_arm64
          elif [ -f "output/${{ env.PROJECT_NAME }}_macos_arm64" ]; then
            cp output/${{ env.PROJECT_NAME }}_macos_arm64 ${{ env.PROJECT_NAME }}_macos_arm64
          else
            echo "Error: Binary not found"
            ls -la build/output/ || ls -la output/ || true
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: ${{ env.PROJECT_NAME }}_macos_arm64
          retention-days: 7

  # ============== Create Release ==============
  create-release:

    needs: [build-windows-amd64,build-linux-amd64, build-linux-arm64,  build-macos-arm64 ,build-macos-amd64]
    runs-on: ubuntu-22.04
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure
        run: ls -R artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          cp artifacts/linux-amd64/${{ env.PROJECT_NAME }}_linux_amd64 release/
          cp artifacts/linux-arm64/${{ env.PROJECT_NAME }}_linux_arm64 release/
          cp artifacts/windows-amd64/${{ env.PROJECT_NAME }}_windows_amd64.exe release/
          cp artifacts/macos-amd64/${{ env.PROJECT_NAME }}_macos_amd64 release/
          cp artifacts/macos-arm64/${{ env.PROJECT_NAME }}_macos_arm64 release/

          # Create checksums
          cd release
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

